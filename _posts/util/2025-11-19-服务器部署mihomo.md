---
layout: post
comments: true
categories: 工具使用
title: 服务器部署mihomo
tags: clash,mihomo
grammar_cjkRuby: true
---

* content
{:toc}

## 前言

我主要是因为需要搭建一个代理服务的环境，用来配置代理服务进行科学上网。现在有很多clash的客户端，但是他们都需要在设备上安装软件，而我期望的方式是直接设置代理服务即可，无需在每台设备上安装clash的客户端，所以要部署在内网服务器作为代理网关。这样所有设备只需要配置代理地址，就能使用统一的代理服务。

## 目标

1. 使用订阅连接自动更新路由配置，需要定期更新，并且支持简单快捷的切换订阅连接地址
2. 带ui控制台，方便管理
3. 部署在内网服务器，无需公开订阅连接，客户端只需要设置代理地址，配置账号密码即可使用代理
4. 在linux服务器上使用命令行部署，通过docker容器化运行

## 部署

### clash、clash meta和mihomo简介

Clash 是一款用 Go 编写的基于规则的代理工具，最初由 Dreamacro 开发。它支持多种代理协议，包括 Shadowsocks、VMess、Trojan 等。

Clash Meta（现更名为 Mihomo）是基于 Clash 开源项目的二次开发版本。它继承了 Clash 的核心功能并增加了一些独特的特性，包括部分原 Clash Premium 核心的功能。相比于 Clash，Clash Meta/Mihomo 引入了更多协议支持（如 VLESS XTLS、Trojan XTLS、Hysteria 等）和更丰富的规则控制。

在 2023 年经历了 Clash for Windows 删库事件之后，原 Clash 项目停止更新，于是开发者将 Clash Meta 改名为 Mihomo，继续进行维护和更新。

### 环境准备

首先我们需要准备部署环境和创建工作目录：

```bash
# 创建工作目录
mkdir -p ~/workspace/mihomo/config
cd ~/workspace/mihomo
```

### docker compose部署

创建 `docker-compose.yml` 文件：

```yaml
version: '3.8'

services:
  mihomo:
    image: metaflow/mihomo:latest
    container_name: mihomo
    restart: always
    network_mode: host
    volumes:
      - ./config:/root/.config/mihomo
    environment:
      - TZ=Asia/Shanghai
    command: >
      mihomo -d /root/.config/mihomo
```

### 配置文件准备

创建基础配置文件 `config/config.yaml`：

```yaml
# Mihomo 配置文件示例
mixed-port: 7890
allow-lan: true
bind-address: "*"
mode: rule
log-level: info
ipv6: true
external-controller: 0.0.0.0:9090
secret: "your-secret-password"
external-ui: /etc/mihomo/ui
external-ui-name: metacubexd
external-ui-url: "https://github.com/MetaCubeX/metacubexd/archive/refs/heads/gh-pages.zip"
dns:
  enable: true
  listen: 0.0.0.0:1053
  ipv6: true
  enhanced-mode: fake-ip
  fake-ip-range: 198.18.0.1/16
  default-nameserver:
    - 223.5.5.5
    - 114.114.114.114
  nameserver:
    - https://doh.pub/dns-query
    - https://dns.alidns.com/dns-query
  fallback:
    - https://doh.dns.sb/dns-query
    - https://dns.cloudflare.com/dns-query
    - https://dns.google.com/dns-query
  fallback-filter:
    geoip: true
    geoip-code: CN
    ipcidr:
      - 240.0.0.0/4
    domain:
      - "+.google.com"
      - "+.youtube.com"
      - "+.facebook.com"
      - "+.twitter.com"
      - "+.instagram.com"

# 订阅配置，这里使用示例链接，实际使用时请替换为自己的订阅链接
proxy-providers:
  my_provider:
    type: http
    url: "https://clash.example.top/subscribe"  # 替换为实际订阅链接
    interval: 3600
    path: ./proxy_providers/my_provider.yaml
    health-check:
      enable: true
      url: http://www.gstatic.com/generate_204
      interval: 300

proxy-groups:
  - name: PROXY
    type: select
    use:
      - my_provider
    proxies:
      - DIRECT
    url: http://www.gstatic.com/generate_204
    interval: 300

rule-providers:
  reject:
    type: http
    behavior: domain
    url: "https://cdn.jsdelivr.net/gh/Loyalsoldier/clash-rules@release/reject.txt"
    path: ./rule_providers/reject.yaml
    interval: 86400
  icloud:
    type: http
    behavior: domain
    url: "https://cdn.jsdelivr.net/gh/Loyalsoldier/clash-rules@release/icloud.txt"
    path: ./rule_providers/icloud.yaml
    interval: 86400
  apple:
    type: http
    behavior: domain
    url: "https://cdn.jsdelivr.net/gh/Loyalsoldier/clash-rules@release/apple.txt"
    path: ./rule_providers/apple.yaml
    interval: 86400
  google:
    type: http
    behavior: domain
    url: "https://cdn.jsdelivr.net/gh/Loyalsoldier/clash-rules@release/google.txt"
    path: ./rule_providers/google.yaml
    interval: 86400
  proxy:
    type: http
    behavior: domain
    url: "https://cdn.jsdelivr.net/gh/Loyalsoldier/clash-rules@release/proxy.txt"
    path: ./rule_providers/proxy.yaml
    interval: 86400
  direct:
    type: http
    behavior: domain
    url: "https://cdn.jsdelivr.net/gh/Loyalsoldier/clash-rules@release/direct.txt"
    path: ./rule_providers/direct.yaml
    interval: 86400
  private:
    type: http
    behavior: domain
    url: "https://cdn.jsdelivr.net/gh/Loyalsoldier/clash-rules@release/private.txt"
    path: ./rule_providers/private.yaml
    interval: 86400
  gfw:
    type: http
    behavior: domain
    url: "https://cdn.jsdelivr.net/gh/Loyalsoldier/clash-rules@release/gfw.txt"
    path: ./rule_providers/gfw.yaml
    interval: 86400
  greatfire:
    type: http
    behavior: domain
    url: "https://cdn.jsdelivr.net/gh/Loyalsoldier/clash-rules@release/greatfire.txt"
    path: ./rule_providers/greatfire.yaml
    interval: 86400
  tld-not-cn:
    type: http
    behavior: domain
    url: "https://cdn.jsdelivr.net/gh/Loyalsoldier/clash-rules@release/tld-not-cn.txt"
    path: ./rule_providers/tld-not-cn.yaml
    interval: 86400
  telegramcidr:
    type: http
    behavior: ipcidr
    url: "https://cdn.jsdelivr.net/gh/Loyalsoldier/clash-rules@release/telegramcidr.txt"
    path: ./rule_providers/telegramcidr.yaml
    interval: 86400
  cncidr:
    type: http
    behavior: ipcidr
    url: "https://cdn.jsdelivr.net/gh/Loyalsoldier/clash-rules@release/cncidr.txt"
    path: ./rule_providers/cncidr.yaml
    interval: 86400
  lancidr:
    type: http
    behavior: ipcidr
    url: "https://cdn.jsdelivr.net/gh/Loyalsoldier/clash-rules@release/lancidr.txt"
    path: ./rule_providers/lancidr.yaml
    interval: 86400
  applications:
    type: http
    behavior: classical
    url: "https://cdn.jsdelivr.net/gh/Loyalsoldier/clash-rules@release/applications.txt"
    path: ./rule_providers/applications.yaml
    interval: 86400

rules:
  - RULE-SET,applications,DIRECT
  - DOMAIN,clash.razord.top,DIRECT
  - DOMAIN,yacd.haishan.me,DIRECT
  - RULE-SET,private,DIRECT
  - RULE-SET,reject,REJECT
  - RULE-SET,icloud,DIRECT
  - RULE-SET,apple,DIRECT
  - RULE-SET,google,PROXY
  - RULE-SET,proxy,PROXY
  - RULE-SET,direct,DIRECT
  - RULE-SET,lancidr,DIRECT
  - RULE-SET,cncidr,DIRECT
  - RULE-SET,telegramcidr,PROXY
  - RULE-SET,gfw,PROXY
  - RULE-SET,greatfire,PROXY
  - RULE-SET,tld-not-cn,PROXY
  - GEOIP,CN,DIRECT
  - MATCH,PROXY
```

### 更新订阅脚本

创建订阅更新脚本 `update_config.sh`：

```bash
#!/bin/bash

# 订阅更新脚本
# 设置环境变量
CONFIG_DIR="/root/workspace/mihomo/config"
SUBSCRIPTION_URL="https://clash.example.top/subscribe"  # 替换为实际订阅链接
CONFIG_FILE="$CONFIG_DIR/config.yaml"
MIHOMO_API_URL="http://127.0.0.1:9090"
MIHOMO_SECRET="your-secret-password"  # 与配置文件中的secret一致

# 日志函数
log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1"
}

# 更新配置函数
update_config() {
    log "开始更新配置..."
    
    # 备份当前配置
    cp "$CONFIG_FILE" "$CONFIG_FILE.backup.$(date +%Y%m%d_%H%M%S)" 2>/dev/null || {
        log "警告: 无法创建备份文件"
    }
    
    # 更新配置文件中的订阅链接
    if command -v curl >/dev/null 2>&1; then
        # 从配置文件中更新订阅链接
        sed -i "s|url: \"https://[^/]*\.[^/\"']*/subscribe[^\"']*\(|url: \"$SUBSCRIPTION_URL\"|g" "$CONFIG_FILE"
        log "配置文件中的订阅链接已更新"
    else
        log "错误: curl 命令未找到"
    fi
    
    # 重新加载配置
    reload_config
}

# 重新加载配置函数
reload_config() {
    log "重新加载 Mihomo 配置..."
    
    # 通过API重新加载配置
    if curl -s -X POST \
        -H "Content-Type: application/json" \
        -H "Authorization: Bearer $MIHOMO_SECRET" \
        -d "{\"path\":\"$CONFIG_FILE\"}" \
        "$MIHOMO_API_URL/configs" > /dev/null 2>&1; then
        log "配置重新加载成功"
    else
        log "错误: 配置重新加载失败，尝试重启容器"
        # 如果API方式失败，尝试重启容器
        docker restart mihomo > /dev/null 2>&1 && log "容器已重启" || log "错误: 无法重启容器"
    fi
}

# 主函数
main() {
    log "开始执行订阅更新任务"
    update_config
    log "订阅更新任务完成"
}

# 执行主函数
main
```

### 设置定时任务

为了让配置自动更新，我们需要添加一个cron任务。创建 `set_cron.sh` 脚本来设置定时任务：

```bash
#!/bin/bash

# 设置定时任务脚本
# 每6小时更新一次订阅配置
CRON_JOB="0 */6 * * * /bin/bash /root/workspace/mihomo/update_config.sh >> /root/workspace/mihomo/cron.log 2>&1"

# 添加定时任务
(crontab -l 2>/dev/null; echo "$CRON_JOB") | crontab -

echo "定时任务已设置，每6小时更新一次订阅配置"
```

### 启动服务

现在让我们启动服务：

```bash
# 给脚本添加执行权限
chmod +x update_config.sh
chmod +x set_cron.sh

# 启动 mihomo 服务
docker-compose up -d

# 设置定时任务
./set_cron.sh
```

## 使用

### 配置文件说明

- `config.yaml`: 主配置文件，包含代理端口、规则、DNS等设置
- `proxy_providers`: 代理提供者配置，用于从订阅链接获取节点信息
- `rule_providers`: 规则提供者，用于更新规则集
- `external-controller`: 外部控制器地址，用于API控制
- `external-ui`: Web UI 控制台

### API 控制

Mihomo 提供了丰富的 RESTful API 用于控制和监控：

1. 重新加载配置：
```bash
curl -X POST \
  -H "Authorization: Bearer your-secret-password" \
  -H "Content-Type: application/json" \
  -d '{"path":"/root/.config/mihomo/config.yaml"}' \
  http://localhost:9090/configs
```

2. 获取当前配置：
```bash
curl -H "Authorization: Bearer your-secret-password" \
  http://localhost:9090/configs
```

3. 获取代理组信息：
```bash
curl -H "Authorization: Bearer your-secret-password" \
  http://localhost:9090/proxies
```

### Web UI 管理

Mihomo 集成了 Metacubexd 作为 Web UI 管理界面，可以通过以下地址访问：

```
http://<服务器IP>:9090/ui
```

访问时需要输入配置文件中设定的密码，然后就可以通过 Web 界面管理代理、切换节点、查看连接等。

### 客户端配置

1. **Chrome 浏览器使用 Zero Omega 插件**
   - 安装 Zero Omega 扩展
   - 配置代理地址为内网服务器 IP 和端口 7890
   - 设置用户名密码（如果配置了认证）

2. **电脑系统级别代理**
   - Windows: 设置 > 网络和 Internet > 代理 > 手动设置代理
   - macOS: 系统偏好设置 > 网络 > 高级 > 代理
   - Linux: 系统设置 > 网络 > 网络代理

3. **手机配置 WiFi 代理**
   - 连接 WiFi 时设置代理
   - 类型: Manual
   - 服务器: 内网服务器 IP
   - 端口: 7890

这样就完成了 mihomo 在内网服务器上的部署，实现了统一的代理服务管理。